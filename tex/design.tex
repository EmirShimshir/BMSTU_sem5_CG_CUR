\chapter{Конструкторская часть}

В данном разделе представлены требования к программному обеспечению, 
рассмотрены структуры данных, алгоритмы и математические уравнения, выбранные для построения сцены.

\section{Требование к программному обеспечению}
Программа должна обладать следующим функционалом:
\begin{itemize}[label*=---]
    \item изменение положения камеры и направления её взгляда;
    \item изменения характеристик волны;
    \item изменения характеристик капли;
    \item изменение алгоритма закраски;
    \item возможность отрисовки полигонов модели.
\end{itemize}

\section{Описание структур данных}
Сцена представляет собой массив моделей, объект камеры и объект источника освещения.
\begin{enumerate}
	\item Модель включает в себя следующие данные:
	\begin{itemize}
		\item массив вершин фигуры;
		\item массив полигонов фигуры;
		\item массив векторов нормалей к вершинам;
		\item цвет поверхности;
		\item матрица аффинных преобразований.
	\end{itemize}
	\item Камера содержит:
	\begin{itemize}
		\item положение в пространстве;
		\item значения углов тангажа и рыскания;
		\item направление взгляда и верха;
	\end{itemize}
	\item Источник освещения характеризуется вектором распространения лучей света или положением в пространстве.
\end{enumerate}

\section{Общий алгоритм построения изображения}

Алгоритм генерации изображения представлен на рисунке~\ref{img:schema_01_Shimshir}.
На вход подаются характеристики моделей, камеры, источника освещения.
На выход выдается результат построения буфера кадра сцены.

\img{160mm}{schema_01_Shimshir}{Общая схема алгоритма синтеза изображения}

\section{Аффинные преобразования}

В представленном алгоритме синтеза изображения первым этапом необходимо преобразовать модель в мировое пространство. 
Такое действие осуществляется с помощью матриц аффинных преобразований~\cite{porevcg}.

\begin{itemize}
	\item Поворот вокруг координатных осей описывается углом $\alpha$ и осью вращения.
	Матрица поворота имеет вид:
	\begin{itemize}
		\item вокруг оси OX:
		\begin{equation}
			\begin{pmatrix}
				1 	& 0 		  & 0 	       & 0 \\
				0 	& cos \alpha  & sin \alpha & 0 \\
				0	& -sin \alpha & cos \alpha & 0 \\
				0 	& 0 		  & 0          & 1
			\end{pmatrix}
		\end{equation}
		\item вокруг оси OY:
			\begin{equation}
			\begin{pmatrix}
				cos \alpha 	& 0 & -sin \alpha & 0 \\
				0 			& 1 & 0 		  & 0 \\
				sin \alpha	& 0 & cos \alpha  & 0 \\
				0 			& 0 & 0           & 1
			\end{pmatrix}
		\end{equation}
		\item вокруг оси OZ:
		\begin{equation}
			\begin{pmatrix}
				cos \alpha 	 & sin \alpha & 0 & 0 \\
				-sin \alpha  & cos \alpha & 0 & 0 \\
				0	 		 & 0		  & 1 & 0 \\
				0 			 & 0 		  & 0 & 1
			\end{pmatrix}
		\end{equation}
	\end{itemize}
	\item Перенос в трехмерном пространстве задается значениями вдоль координатных осей.
	Матрица переноса имеет вид:
	\begin{equation}
		\begin{pmatrix}
			1  & 0  & 0  & 0 \\
			0  & 1  & 0  & 0 \\
			0  & 0  & 1  & 0 \\
			dx & dy	& dz & 1
		\end{pmatrix}
	\end{equation}
\end{itemize}

\newpage

\section{Приведение к пространству камеры}

Для перемещения по сцене используется камера, задаваемая точкой положения в пространстве и собственной системой координат, которая состоит из трех ортогональных векторов.

Обозначим:
\begin{itemize}
	\item Point (P) --- положение камеры;
	\item forward (F) --- вектор взгляда;
	\item Up (U) --- вектор вверх;
	\item Right (R) --- вектор вправо.
\end{itemize}

Для перехода в пространство камеры выполняется в два этапа, указанные далее.
\begin{enumerate}
	\item Перенос полигона в отрицательную стороны от камеры на расстояние Point с помощью матрицы переноса~\cite{palcing-camera}:
	\begin{equation}
		\begin{pmatrix}
			1  & 0  & 0  & 0 \\
			0  & 1  & 0  & 0 \\
			0  & 0  & 1  & 0 \\
			-Px & -Py & -Pz & 1
		\end{pmatrix}
	\end{equation}
	\item Преобразование полигона к системе координат камеры при помощи матрицы поворота~\cite{palcing-camera}:
	\begin{equation}
		\begin{pmatrix}
			Rx  & Ux  & Fx  & 0 \\
			Ry  & Uy  & Fy  & 0 \\
			Rz  & Uz  & Fz  & 0 \\
			0   & 0   & 0   & 1
		\end{pmatrix}
	\end{equation}
\end{enumerate}

Управление камеры производится с помощью изменения углом Эйлера.
Обозначим $\alpha$ --- угол поворота вокруг оси ОУ (тангаж) и  $\beta$ --- угол поворота вокруг оси OX (рыскание).
Тогда координаты вектора направления камеры можно вычислить по следующим формулам:
\begin{equation}
	F_x = cos(\alpha) \cdot cos(\beta)
\end{equation}
\begin{equation}
	F_y = sin(\alpha)
\end{equation}
\begin{equation}
	F_z = cos(\alpha) \cdot sin(\beta)
\end{equation}

\section{Невидимые грани}
С помощью отбрасывания нелицевых граней моделей при построении изображения можно существенно сократить временные затраты, так как невидимые полигоны не будут растеризоваться.
Для определения видимости грани требуется использовать формулу:
\begin{equation}
	(\overrightarrow{N}, \overrightarrow{V}) = \begin{cases}
		 \geq 0,~\text{если грань невидима} \\
		 < 0,~\text{если грань видима}
	\end{cases},
\end{equation}
где $\overrightarrow{N}$ --- вектор внешней нормали к грани модели, $\overrightarrow{V}$ --- вектор от камеры до любой точки грани.


\section{Описание уравнения бегущей волны}
Бегущие волны моделируются свободными гармоническими колебаниями. 
Для перехода в нормализированное пространство, в котором значение функции лежит в пределах от 0 до 1, 
выполняется преобразование:

\begin{equation}
    f(x) = \dfrac{\sin{x} + 1}{2}
\end{equation}

С целью получения реалистичного изображения волн необходимо принять во внимание тот факт, 
что волны могут иметь большую крутизну и остроту пиков~\cite{WAVE}.

\begin{equation}
    f(x) = \dfrac{\sin{x} + 1}{2}
\end{equation}

Необходимо также учитывать направление волны. Ее моделирование происходит в двумерном поле высот, 
поэтому требуется определять движение волн в обоих направлениях. Вектор направления должен быть 
параллельным плоскости невозмущенной поверхности жидкости, т. е. иметь координату z, равную нулю.~\cite{WAVE}.

\begin{equation}
    S = Dir(x,y)*Pos(x,y)
\end{equation}

где $Dir(x, y)$ — вектор направления волны, $Pos(x, y)$ — вектор координат точки.

Учет частоты происходит в формуле в соответствии с известным соотношением определения частоты $f$:

\begin{equation}
    f = \dfrac{2\pi}{\lambda}
\end{equation}

где $\lambda$ — длина волны.

Тогда получим:

\begin{equation}
    S = Dir(x,y)*Pos(x,y)f
\end{equation}

Для учета скорости волны необходимо определить фазовую постоянную в соответствии с выражением~\cite{WAVE}.
\begin{equation}
    \psi = vf = \dfrac{2v\pi}{\lambda}
\end{equation}

Окончательное выражение для вычисления координаты точки $z$ на поверхности жидкости 
в зависимости от ее координат $x$, $y$ и времени имеет следующий вид:
\begin{equation}
    f(x,y,t) = A\left(\dfrac{\sin{S} + 1}{2}\right)^k
\end{equation}

где $S = Dir(x, y)*Pos(x, y)f + t\psi$

\section{Описание круговых волн}
Учесть этот эффект можно с помощью переопределения вектора направления в каждой точке поверхности 
и изменения координаты точки смещением начала координат в точку центра круговой волны~\cite{WAVE}.

\begin{equation}
        D_i(x,y) = \left(\dfrac{(x, y) - C_i}{|(x, y) - C_i|}\right),
\end{equation}

$$X_n = X - X_c; Y_n = Y - Y_c$$

где $C_i$ — точка начала распространения $i$-й круговой волны; 
$X$, $Y$ — координаты рассматриваемой точки; 
$X_n$, $Y_n$ — преобразованные координаты точки; 
$X_c$, $Y_c$ — координаты точки начала распространения волны.


Измененные значения подставляются в формулу бегущей волны.

\section{Описание вычисления нормалей}

Используя уравнения поверхностей, определим нормали в любой ее точке. 
Уравнение нормали к поверхности в точке $(x, y, z)$:

\begin{equation}
    N(x,y,z) = NB(x,y,z)\otimes NT(x,y,z)
\end{equation}

где $NB(x, y, z)$ и $NT(x, y, z)$ — частные производные по x и y;

\begin{align}
    NB(x, y, z) = \dfrac{\partial f(x,y,t)}{\partial x} \\
    NT(x, y, z) = \dfrac{\partial f(x,y,t)}{\partial y}
\end{align}

где $f(x, y, t)$ — итоговое уравнение поверхности;

\begin{align}
    \dfrac{\partial f(x,y,t)}{\partial x} = 0.5Dir_x f A\left(\dfrac{\sin{S} + 1}{2}\right)^{k-1}\cos{S}, \\
    \dfrac{\partial f(x,y,t)}{\partial y} = 0.5Dir_y f A\left(\dfrac{\sin{S} + 1}{2}\right)^{k-1}\cos{S}.
\end{align}


Задавая векторы нормалей проекциями на координатные оси, получим~\cite{WAVE}.

\begin{align}
    NB(x, y, z) &= \left(\dfrac{\partial x}{\partial x}, \dfrac{\partial y}{\partial x}, \dfrac{\partial f(x,y,t)}{\partial x}\right) = \left(1, 0, \dfrac{\partial f(x,y,t)}{\partial x}\right), \\
    NT(x, y, z) &= \left(\dfrac{\partial x}{\partial y}, \dfrac{\partial y}{\partial y}, \dfrac{\partial f(x,y,t)}{\partial y}\right) = \left(0, 1, \dfrac{\partial f(x,y,t)}{\partial y}\right).
\end{align}

\section*{Вывод}
В данном разделе были представлены требования к программному обеспечению, рассмотрены структуры данных, алгоритмы и математические уравнения, выбранные для построения сцены.
